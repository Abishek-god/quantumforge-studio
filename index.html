<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Quantum Forge | GPT-OSS</title>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary: #6366f1;
Â  Â  Â  Â  Â  Â  --primary-dark: #4f46e5;
Â  Â  Â  Â  Â  Â  --success: #10b981;
Â  Â  Â  Â  Â  Â  --danger: #ef4444;
Â  Â  Â  Â  Â  Â  --bg: #f8fafc;
Â  Â  Â  Â  Â  Â  --sidebar: #ffffff;
Â  Â  Â  Â  Â  Â  --text-main: #1e293b;
Â  Â  Â  Â  Â  Â  --text-muted: #64748b;
Â  Â  Â  Â  Â  Â  --border: #e2e8f0;
Â  Â  Â  Â  Â  Â  --anim-speed: 0.3s;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  margin: 0; font-family: 'Inter', system-ui, sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--bg); color: var(--text-main);
Â  Â  Â  Â  Â  Â  height: 100vh; display: flex; overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .hidden { display: none !important; }

Â  Â  Â  Â  /* --- AUTH VIEW --- */
Â  Â  Â  Â  #authView {
Â  Â  Â  Â  Â  Â  width: 100%; display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
Â  Â  Â  Â  Â  Â  position: absolute; height: 100vh; z-index: 100;
Â  Â  Â  Â  Â  Â  transition: opacity 0.5s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .auth-card {
Â  Â  Â  Â  Â  Â  background: white; padding: 40px; border-radius: 20px;
Â  Â  Â  Â  Â  Â  width: 100%; max-width: 380px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
Â  Â  Â  Â  Â  Â  animation: slideUp 0.5s ease-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- BUTTONS --- */
Â  Â  Â  Â  button { cursor: pointer; border: none; transition: 0.2s; font-weight: 600; }
Â  Â  Â  Â  .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 10px; }
Â  Â  Â  Â  .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
Â  Â  Â  Â  .btn-success { background: var(--success); color: white; padding: 10px 20px; border-radius: 10px; width: 100%; }
Â  Â  Â  Â  .btn-success:hover { filter: brightness(1.1); }
Â  Â  Â  Â  .btn-logout { color: var(--danger); border-top: 1px solid var(--border); width: 100%; text-align: left; padding: 15px 10px; background: transparent; }
Â  Â  Â  Â  .btn-logout:hover { background: #fff1f2; }

Â  Â  Â  Â  /* --- APP LAYOUT --- */
Â  Â  Â  Â  #appView { width: 100%; display: flex; flex-direction: row; animation: fadeIn 0.5s ease-in; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; padding: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .main-content { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }

Â  Â  Â  Â  .nav-btn {
Â  Â  Â  Â  Â  Â  width: 100%; text-align: left; padding: 10px; margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  border-radius: 8px; border: none; background: transparent;
Â  Â  Â  Â  Â  Â  cursor: pointer; color: var(--text-main); font-weight: 500;
Â  Â  Â  Â  Â  Â  transition: var(--anim-speed);
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-btn:hover { background: #f1f5f9; transform: translateX(5px); }

Â  Â  Â  Â  /* --- CHAT BOX --- */
Â  Â  Â  Â  .chat-box { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
Â  Â  Â  Â  .message { max-width: 85%; line-height: 1.6; opacity: 0; animation: msgSlide 0.4s forwards; }
Â  Â  Â  Â  .message-content { padding: 12px 18px; border-radius: 15px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .user { align-self: flex-end; }
Â  Â  Â  Â  .user .message-content { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
Â  Â  Â  Â  .ai { align-self: flex-start; }
Â  Â  Â  Â  .ai .message-content { background: #f1f5f9; color: var(--text-main); border-bottom-left-radius: 2px; }

Â  Â  Â  Â  /* --- CODE BOX & COPY --- */
Â  Â  Â  Â  .code-container { position: relative; margin: 15px 0; border-radius: 10px; overflow: hidden; background: #1e1e1e; }
Â  Â  Â  Â  .code-header {Â 
Â  Â  Â  Â  Â  Â  display: flex; justify-content: space-between; align-items: center;Â 
Â  Â  Â  Â  Â  Â  background: #2d2d2d; padding: 6px 15px; font-size: 11px; color: #aaa;Â 
Â  Â  Â  Â  Â  Â  font-family: monospace; border-bottom: 1px solid #3d3d3d;
Â  Â  Â  Â  }
Â  Â  Â  Â  .copy-btn {Â 
Â  Â  Â  Â  Â  Â  background: #444; color: #fff; border: none; padding: 4px 8px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px; font-size: 10px; cursor: pointer; transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .copy-btn:hover { background: #666; }
Â  Â  Â  Â  pre { margin: 0 !important; padding: 15px; overflow-x: auto; }
Â  Â  Â  Â  code { font-family: 'Fira Code', monospace; font-size: 14px; }

Â  Â  Â  Â  .input-container { padding: 20px 40px; border-top: 1px solid var(--border); display: flex; gap: 12px; background: white; }
Â  Â  Â  Â  input[type="text"], input[type="email"], input[type="password"] {Â 
Â  Â  Â  Â  Â  Â  padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; width: 100%; box-sizing: border-box;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ANIMATIONS --- */
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
Â  Â  Â  Â  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
Â  Â  Â  Â  @keyframes msgSlide { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
Â  Â  </style>
</head>
<body>

Â  Â  <div id="authView">
Â  Â  Â  Â  <div class="auth-card">
Â  Â  Â  Â  Â  Â  <h2 style="margin-top:0">Quantum Forge</h2>
Â  Â  Â  Â  Â  Â  <input type="email" id="email" placeholder="Email" style="margin-bottom:10px">
Â  Â  Â  Â  Â  Â  <input type="password" id="password" placeholder="Password" style="margin-bottom:20px">
Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="handleAuth('login')" style="width:100%">Sign In</button>
Â  Â  Â  Â  Â  Â  <button class="nav-btn" onclick="handleAuth('signup')" style="text-align:center; margin-top:10px">Create Account</button>
Â  Â  Â  Â  Â  Â  <div id="authError" style="color:var(--danger); font-size:12px; margin-top:15px; text-align:center"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="appView" class="hidden">
Â  Â  Â  Â  <div class="sidebar">
Â  Â  Â  Â  Â  Â  <div class="sidebar-user" style="display:flex; align-items:center; gap:12px; padding-bottom:20px; border-bottom:1px solid var(--border); margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <img id="sideAvatar" src="https://via.placeholder.com/42" style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="sideName" style="font-weight:700; font-size:14px">User</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:10px; color:var(--primary)">GPT-OSS 120B</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label style="font-size: 10px; color: var(--text-muted); font-weight: 800; margin-bottom: 5px;">AI PERSONA</label>
Â  Â  Â  Â  Â  Â  <select id="modelSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:20px; background:var(--bg); font-weight:600;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="jarvis">Jarvis (Research)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="friday">Friday (Creative)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="vision">Vision (Logic)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="atlas">Atlas (Balanced)</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <button class="nav-btn" onclick="showView('chat')">ğŸ’¬ Chat</button>
Â  Â  Â  Â  Â  Â  <button class="nav-btn" onclick="showView('profile')">âš™ï¸ Profile Settings</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="flex:1; margin-top:20px; overflow-y:auto">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="newChat()" style="width:100%; font-size:13px; margin-bottom:15px">+ New Chat</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="historyList"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button onclick="logout()" class="btn-logout">Logout</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="main-content">
Â  Â  Â  Â  Â  Â  <div id="chatView" style="height:100%; display:flex; flex-direction:column">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-box" id="chatBox"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="userInput" placeholder="Message your AI..." onkeypress="if(event.key==='Enter') sendMessage()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="sendMessage()">Send</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="profileView" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-container" style="padding:40px; max-width:500px; margin:0 auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Settings</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avatar-edit-wrapper" style="position:relative; width:100px; margin-bottom:20px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="profAvatar" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="avatarFile" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid white;">ğŸ“·</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="avatarFile" accept="image/*" style="display:none" onchange="uploadAvatar()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:12px; font-weight:700; color:var(--text-muted)">DISPLAY NAME</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="profName" style="margin-bottom:15px">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:12px; font-weight:700; color:var(--text-muted)">AVATAR URL</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="profUrl" readonly style="background:#f1f5f9; margin-bottom:20px">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-success" onclick="saveProfile()">Save Profile</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="profStatus" style="font-size:12px; margin-top:10px"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const SB_URL = "https://yacuohapxztvkyabvfqf.supabase.co";
Â  Â  Â  Â  const SB_KEY = "sb_publishable_YyAyhOJ7K5orADFild0jlg_Z25bWDwn";Â 
Â  Â  Â  Â  const AI_URL = "https://quantumforge-studio.onrender.com/chat";
Â  Â  Â  Â  const sb = window.supabase.createClient(SB_URL, SB_KEY);
Â  Â  Â  Â  let user = null;
Â  Â  Â  Â  let activeChatId = null;

Â  Â  Â  Â  // --- MARKDOWN & COPY FEATURE ---
Â  Â  Â  Â  marked.setOptions({
Â  Â  Â  Â  Â  Â  highlight: function(code, lang) {
Â  Â  Â  Â  Â  Â  Â  Â  return hljs.highlightAuto(code).value;
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  langPrefix: 'hljs language-'
Â  Â  Â  Â  });

Â  Â  Â  Â  // Wrap code blocks with Copy UI
Â  Â  Â  Â  function wrapCodeBlocks(html) {
Â  Â  Â  Â  Â  Â  const temp = document.createElement('div');
Â  Â  Â  Â  Â  Â  temp.innerHTML = html;
Â  Â  Â  Â  Â  Â  temp.querySelectorAll('pre').forEach(pre => {
Â  Â  Â  Â  Â  Â  Â  Â  const code = pre.querySelector('code');
Â  Â  Â  Â  Â  Â  Â  Â  const lang = code.className.replace('hljs language-', '') || 'code';
Â  Â  Â  Â  Â  Â  Â  Â  const container = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  container.className = 'code-container';
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="code-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${lang}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="copy-btn" onclick="copyCode(this)">Copy</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  pre.parentNode.insertBefore(container, pre);
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(pre);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return temp.innerHTML;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function copyCode(btn) {
Â  Â  Â  Â  Â  Â  const code = btn.closest('.code-container').querySelector('code').innerText;
Â  Â  Â  Â  Â  Â  await navigator.clipboard.writeText(code);
Â  Â  Â  Â  Â  Â  btn.innerText = 'Done!';
Â  Â  Â  Â  Â  Â  btn.style.background = '#10b981';
Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = 'Copy';Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.style.background = '#444';
Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- AUTH ---
Â  Â  Â  Â  async function handleAuth(type) {
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const { error } = type === 'login'Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? await sb.auth.signInWithPassword({ email, password })
Â  Â  Â  Â  Â  Â  Â  Â  : await sb.auth.signUp({ email, password });
Â  Â  Â  Â  Â  Â  if (error) document.getElementById('authError').innerText = error.message;
Â  Â  Â  Â  Â  Â  else checkSession();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function logout() { await sb.auth.signOut(); location.reload(); }

Â  Â  Â  Â  function showView(view) {
Â  Â  Â  Â  Â  Â  document.getElementById('chatView').classList.toggle('hidden', view !== 'chat');
Â  Â  Â  Â  Â  Â  document.getElementById('profileView').classList.toggle('hidden', view !== 'profile');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadProfile() {
Â  Â  Â  Â  Â  Â  const { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profName').value = data.name || "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profUrl').value = data.avatar_url || "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profAvatar').src = data.avatar_url || "https://via.placeholder.com/100";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sideAvatar').src = data.avatar_url || "https://via.placeholder.com/42";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sideName').innerText = data.name || "User";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function uploadAvatar() {
Â  Â  Â  Â  Â  Â  const file = document.getElementById('avatarFile').files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â  const path = `${user.id}/${Date.now()}.png`;
Â  Â  Â  Â  Â  Â  const { error } = await sb.storage.from('avatar').upload(path, file);
Â  Â  Â  Â  Â  Â  if (!error) {
Â  Â  Â  Â  Â  Â  Â  Â  const { data: { publicUrl } } = sb.storage.from('avatar').getPublicUrl(path);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profUrl').value = publicUrl;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profAvatar').src = publicUrl;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveProfile() {
Â  Â  Â  Â  Â  Â  const name = document.getElementById('profName').value;
Â  Â  Â  Â  Â  Â  const avatar = document.getElementById('profUrl').value;
Â  Â  Â  Â  Â  Â  await sb.from('profiles').upsert({ id: user.id, name, avatar_url: avatar });
Â  Â  Â  Â  Â  Â  document.getElementById('profStatus').innerText = "âœ“ Saved";
Â  Â  Â  Â  Â  Â  loadProfile();
Â  Â  Â  Â  }

Â  Â  Â  Â  function addMsg(role, content) {
Â  Â  Â  Â  Â  Â  const box = document.getElementById('chatBox');
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = `message ${role}`;
Â  Â  Â  Â  Â  Â  let htmlContent = role === 'ai' ? marked.parse(content) : content;
Â  Â  Â  Â  Â  Â  if (role === 'ai') htmlContent = wrapCodeBlocks(htmlContent);
Â  Â  Â  Â  Â  Â  div.innerHTML = `<div class="message-content">${htmlContent}</div>`;
Â  Â  Â  Â  Â  Â  box.appendChild(div);
Â  Â  Â  Â  Â  Â  div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
Â  Â  Â  Â  Â  Â  box.scrollTop = box.scrollHeight;
Â  Â  Â  Â  Â  Â  return div;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  async function sendMessage() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('userInput');
Â  Â  Â  Â  Â  Â  const text = input.value.trim();
Â  Â  Â  Â  Â  Â  if (!text) return;
Â  Â  Â  Â  Â  Â  if (!activeChatId) activeChatId = crypto.randomUUID();
Â  Â  Â  Â  Â  Â  addMsg('user', text);
Â  Â  Â  Â  Â  Â  input.value = "";
Â  Â  Â  Â  Â  Â  const typing = addMsg('ai', '...');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await sb.from('chats').insert({ user_id: user.id, conversation_id: activeChatId, role: 'user', message: text });
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(AI_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {'Content-Type': 'application/json'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ message: text, model: document.getElementById('modelSelect').value })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  typing.innerHTML = `<div class="message-content">${wrapCodeBlocks(marked.parse(data.reply))}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  typing.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
Â  Â  Â  Â  Â  Â  Â  Â  await sb.from('chats').insert({ user_id: user.id, conversation_id: activeChatId, role: 'ai', message: data.reply });
Â  Â  Â  Â  Â  Â  Â  Â  loadHistory();
Â  Â  Â  Â  Â  Â  } catch (e) { typing.innerText = "Connection error."; }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadHistory() {
Â  Â  Â  Â  Â  Â  const { data } = await sb.from('chats').select('conversation_id, message').eq('user_id', user.id).order('created_at', { ascending: false });
Â  Â  Â  Â  Â  Â  const list = document.getElementById('historyList');
Â  Â  Â  Â  Â  Â  list.innerHTML = "";
Â  Â  Â  Â  Â  Â  const seen = new Set();
Â  Â  Â  Â  Â  Â  data?.forEach(chat => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!seen.has(chat.conversation_id)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seen.add(chat.conversation_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.className = "nav-btn";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.textContent = chat.message.substring(0, 25) + "...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.onclick = () => { activeChatId = chat.conversation_id; document.getElementById('chatBox').innerHTML = ""; loadMessages(chat.conversation_id); showView('chat'); };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadMessages(id) {
Â  Â  Â  Â  Â  Â  const { data } = await sb.from('chats').select('*').eq('conversation_id', id).order('created_at');
Â  Â  Â  Â  Â  Â  data.forEach(m => addMsg(m.role, m.message));
Â  Â  Â  Â  }

Â  Â  Â  Â  function newChat() { activeChatId = null; document.getElementById('chatBox').innerHTML = ""; showView('chat'); }

Â  Â  Â  Â  async function checkSession() {
Â  Â  Â  Â  Â  Â  const { data } = await sb.auth.getSession();
Â  Â  Â  Â  Â  Â  if (data.session) {
Â  Â  Â  Â  Â  Â  Â  Â  user = data.session.user;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authView').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('appView').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  loadProfile();
Â  Â  Â  Â  Â  Â  Â  Â  loadHistory();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  checkSession();
Â  Â  </script>
</body>
</html>
