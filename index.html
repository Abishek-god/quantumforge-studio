<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Forge | GPT-OSS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #f8fafc;
            --sidebar: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            margin: 0; font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg); color: var(--text-main);
            height: 100vh; display: flex; overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- AUTH VIEW --- */
        #authView {
            width: 100%; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            position: absolute; height: 100vh; z-index: 100;
        }
        .auth-card {
            background: white; padding: 40px; border-radius: 20px;
            width: 100%; max-width: 380px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        /* --- APP LAYOUT --- */
        #appView { width: 100%; display: flex; flex-direction: row; }
        
        .sidebar {
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
        }

        .main-content { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }

        /* --- SIDEBAR COMPONENTS --- */
        .sidebar-user {
            display: flex; align-items: center; gap: 12px;
            padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px;
        }
        .sidebar-user img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        .nav-btn {
            width: 100%; text-align: left; padding: 10px; margin-bottom: 5px;
            border-radius: 8px; border: none; background: transparent;
            cursor: pointer; color: var(--text-main); font-weight: 500;
        }
        .nav-btn:hover { background: #f1f5f9; }

        /* --- CHAT COMPONENTS --- */
        .chat-box { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 85%; line-height: 1.6; }
        .message-content { padding: 12px 18px; border-radius: 15px; font-size: 15px; }
        .user { align-self: flex-end; }
        .user .message-content { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; }
        .ai .message-content { background: #f1f5f9; color: var(--text-main); border-bottom-left-radius: 2px; }

        .input-container { padding: 20px 40px; border-top: 1px solid var(--border); display: flex; gap: 12px; }

        /* --- PROFILE VIEW --- */
        .profile-container { padding: 40px; max-width: 500px; margin: 0 auto; width: 100%; }
        .avatar-edit-wrapper { position: relative; width: 100px; height: 100px; margin-bottom: 20px; }
        .avatar-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .upload-overlay {
            position: absolute; bottom: 0; right: 0; background: var(--primary);
            color: white; border-radius: 50%; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white;
        }

        /* --- UI ELEMENTS --- */
        input { padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        button { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="authView">
        <div class="auth-card">
            <h2 style="margin-top:0">Quantum Forge</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" onclick="handleAuth('login')" style="width:100%">Sign In</button>
            <button class="nav-btn" onclick="handleAuth('signup')" style="text-align:center; margin-top:10px">Create Account</button>
            <div id="authError" style="color:#ef4444; font-size:12px; margin-top:15px; text-align:center"></div>
        </div>
    </div>

    <div id="appView" class="hidden">
        <div class="sidebar">
            <div class="sidebar-user">
                <img id="sideAvatar" src="https://via.placeholder.com/42">
                <div>
                    <div id="sideName" style="font-weight:700; font-size:14px">User</div>
                    <div style="font-size:10px; color:var(--primary)">GPT-OSS 120B</div>
                </div>
            </div>

            <button class="nav-btn" onclick="showView('chat')">üí¨ Chat</button>
            <button class="nav-btn" onclick="showView('profile')">‚öôÔ∏è Profile Settings</button>
            
            <div style="flex:1; margin-top:20px; overflow-y:auto">
                <button class="btn-primary" onclick="newChat()" style="width:100%; font-size:13px">+ New Chat</button>
                <div id="historyList" style="margin-top:15px"></div>
            </div>

            <button onclick="logout()" class="nav-btn" style="color:#ef4444; border-top:1px solid var(--border); padding-top:15px">Logout</button>
        </div>

        <div class="main-content">
            <div id="chatView" style="height:100%; display:flex; flex-direction:column">
                <div class="chat-box" id="chatBox"></div>
                <div class="input-container">
                    <input type="text" id="userInput" placeholder="Message GPT-OSS..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <div id="profileView" class="hidden">
                <div class="profile-container">
                    <h2>Settings</h2>
                    <div class="avatar-edit-wrapper">
                        <img id="profAvatar" class="avatar-lg" src="https://via.placeholder.com/100">
                        <label for="avatarFile" class="upload-overlay">üì∑</label>
                        <input type="file" id="avatarFile" accept="image/*" style="display:none" onchange="uploadAvatar()">
                    </div>

                    <label style="font-size:12px; font-weight:700; color:var(--text-muted)">DISPLAY NAME</label>
                    <input type="text" id="profName" placeholder="Enter your name">

                    <label style="font-size:12px; font-weight:700; color:var(--text-muted)">AVATAR URL</label>
                    <input type="text" id="profUrl" readonly style="background:#f1f5f9">

                    <button class="btn-primary" onclick="saveProfile()" id="saveBtn">Save Profile</button>
                    <p id="profStatus" style="font-size:12px; margin-top:10px"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://yacuohapxztvkyabvfqf.supabase.co";
        const SB_KEY = "sb_publishable_YyAyhOJ7K5orADFild0jlg_Z25bWDwn"; 
        const AI_URL = "https://quantumforge-studio.onrender.com/chat";
        const FIXED_MODEL = "jarvis";

        const sb = window.supabase.createClient(SB_URL, SB_KEY);
        let user = null;
        let activeChatId = null;

        // --- AUTH ---
        async function handleAuth(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = type === 'login' 
                ? await sb.auth.signInWithPassword({ email, password })
                : await sb.auth.signUp({ email, password });

            if (error) document.getElementById('authError').innerText = error.message;
            else checkSession();
        }

        async function logout() { await sb.auth.signOut(); location.reload(); }

        // --- NAVIGATION ---
        function showView(view) {
            document.getElementById('chatView').classList.toggle('hidden', view !== 'chat');
            document.getElementById('profileView').classList.toggle('hidden', view !== 'profile');
        }

        // --- PROFILE & STORAGE ---
        async function loadProfile() {
            const { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                document.getElementById('profName').value = data.name || "";
                document.getElementById('profUrl').value = data.avatar_url || "";
                document.getElementById('profAvatar').src = data.avatar_url || "https://via.placeholder.com/100";
                document.getElementById('sideAvatar').src = data.avatar_url || "https://via.placeholder.com/42";
                document.getElementById('sideName').innerText = data.name || "User";
            }
        }

        async function uploadAvatar() {
            const file = document.getElementById('avatarFile').files[0];
            if (!file) return;

            document.getElementById('profStatus').innerText = "Uploading...";
            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}/${Math.random()}.${fileExt}`;

            // Fixed: Using lowercase 'avatar' to match your bucket
            const { error } = await sb.storage.from('avatar').upload(fileName, file);

            if (!error) {
                const { data: { publicUrl } } = sb.storage.from('avatar').getPublicUrl(fileName);
                document.getElementById('profUrl').value = publicUrl;
                document.getElementById('profAvatar').src = publicUrl;
                document.getElementById('profStatus').innerText = "Upload complete! Click Save Profile.";
            } else {
                document.getElementById('profStatus').innerText = "Upload failed: " + error.message;
            }
        }

        async function saveProfile() {
            const name = document.getElementById('profName').value;
            const avatar = document.getElementById('profUrl').value;
            const { error } = await sb.from('profiles').upsert({ id: user.id, name, avatar_url: avatar });
            
            document.getElementById('profStatus').innerText = error ? "Error saving." : "Profile updated!";
            loadProfile();
        }

        // --- CHAT ---
        // Fixed: Return 'div' to prevent TypeError in sendMessage
        function addMsg(role, content) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<div class="message-content">${role === 'ai' ? marked.parse(content) : content}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div; 
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            if (!activeChatId) activeChatId = crypto.randomUUID();

            addMsg('user', text);
            input.value = "";
            const typing = addMsg('ai', '...');

            try {
                await sb.from('chats').insert({ user_id: user.id, conversation_id: activeChatId, role: 'user', message: text });

                const res = await fetch(AI_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, model: FIXED_MODEL })
                });
                const data = await res.json();
                
                // Typing variable is now defined because addMsg returns the element
                typing.innerHTML = `<div class="message-content">${marked.parse(data.reply)}</div>`;
                
                await sb.from('chats').insert({ user_id: user.id, conversation_id: activeChatId, role: 'ai', message: data.reply });
                loadHistory();
            } catch (e) { 
                if (typing) typing.innerText = "Connection error."; 
            }
        }

        async function loadHistory() {
            const { data } = await sb.from('chats').select('conversation_id, message').eq('user_id', user.id).order('created_at', { ascending: false });
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            const seen = new Set();
            data?.forEach(chat => {
                if (!seen.has(chat.conversation_id)) {
                    seen.add(chat.conversation_id);
                    const item = document.createElement('div');
                    item.className = "nav-btn";
                    item.style.fontSize = "12px";
                    item.textContent = chat.message.substring(0, 25) + "...";
                    item.onclick = () => { 
                        activeChatId = chat.conversation_id; 
                        document.getElementById('chatBox').innerHTML = ""; 
                        loadMessages(chat.conversation_id); 
                        showView('chat'); 
                    };
                    list.appendChild(item);
                }
            });
        }

        async function loadMessages(id) {
            const { data } = await sb.from('chats').select('*').eq('conversation_id', id).order('created_at');
            data.forEach(m => addMsg(m.role, m.message));
        }

        function newChat() { activeChatId = null; document.getElementById('chatBox').innerHTML = ""; showView('chat'); }

        async function checkSession() {
            const { data } = await sb.auth.getSession();
            if (data.session) {
                user = data.session.user;
                document.getElementById('authView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                loadProfile();
                loadHistory();
            }
        }
        checkSession();
    </script>
</body>
</html>
